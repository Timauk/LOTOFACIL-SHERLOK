<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo do Sherlock 5.0</title>
    <style>
        .progress-container {
            width: 100%;
            background-color: #f3f3f3;
            border: 1px solid #ccc;
            height: 20px;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            width: 0;
            background-color: #4caf50;
            text-align: center;
            color: white;
            line-height: 20px;
            transition: width 0.3s;
        }
        input[type="text"], input[type="file"] {
            width: 50%;
            padding: 5px;
            margin: 10px 0;
        }
        button {
            padding: 10px;
            margin-top: 10px;
        }
        .btn-sherlock {
            background-color: red;
            color: white;
            padding: 10px;
        }
        .scoreboard {
            margin-top: 20px;
            border: 1px solid #000;
            padding: 10px;
        }
        #log {
            white-space: pre-wrap;
            border: 1px solid #ddd;
            padding: 10px;
            height: 200px;
            overflow-y: scroll;
        }
        canvas {
            width: 100% !important;
        }
    </style>
</head>
<body>
    <h1>Jogo do Sherlock 5.0</h1>

    <!-- Upload de Dados -->
    <h2>Faça upload dos dados (CSV):</h2>
    <input type="file" id="fileInput" />
    <button onclick="carregarDados()">Carregar Dados</button>
    <p id="statusUpload"></p>

    <!-- Treinamento do Modelo -->
    <h2>Treinar/Atualizar Modelo:</h2>
    <button onclick="treinarModelo()">Treinar/Atualizar Modelo</button>

    <!-- Barra de progresso para treinamento -->
    <div class="progress-container">
        <div class="progress-bar" id="progressBar">0%</div>
    </div>
    <p id="statusTreinamento"></p>

    <!-- Botão para carregar o modelo salvo -->
    <h2>Carregar Modelo Salvo</h2>
    <input type="file" id="modelJson" accept=".json"/>
    <input type="file" id="modelWeights" accept=".bin"/>
    <button onclick="carregarModelo()">Carregar Modelo</button>

    <!-- Botão para jogar com o modelo carregado -->
    <h2> Jogar com Sherlock</h2>
    <button onclick="jogarComModelo()">Jogar</button>

    <!-- Ciclo de Previsões do Sherlock -->
    <h2>Ciclo de Previsões Sherlock (50 palpites):</h2>
    <button onclick="iniciarCiclo()">Iniciar Ciclo de Previsões</button>

    <!-- Adicionar checkbox para Jogo Infinito -->
    <label>
        <input type="checkbox" id="jogoInfinito"> Jogo Infinito
    </label>

    <!-- Exibir o gráfico de desempenho -->
    <div id="graficoDesempenho"></div>

    <!-- Botão para salvar o modelo -->
    <h2>Salvar o Modelo Treinado</h2>
    <button onclick="salvarModelo()">Salvar Modelo</button>

    <!-- Resultados dos Palpites -->
    <h3>Resultados dos Palpites:</h3>
    <div id="resultadosCiclo"></div>

    <!-- Gráfico de Desempenho -->
    <div id="graficoDesempenho"></div>
    
    <!-- Placar das Gerações -->
    <div class="scoreboard" id="scoreboard">
        <h3>Placar das Gerações</h3>
        <ul id="geracoesRanking"></ul>
    </div>

    <!-- Área de Logs -->
    <h3>Log de Atividades</h3>
    <div id="log"></div>

    <!-- TensorFlow JS -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-vis"></script>

    <script>
        let dados = [];
        let model; 
        let treinando = false;
        let cicloRodando = false;
        const numCiclos = 50;
        let palpites = [];
        let jogoInfinito = false;
        let campeoes = [];
        let geracaoAtual = 1;
        let ranking = [];
        let geracoes = [];
        let pontosGeracoes = [];
       
        // Função para carregar dados do CSV
        function carregarDados() {
            const input = document.getElementById('fileInput').files[0];
            if (!input) {
                alert("Por favor, selecione um arquivo CSV.");
                return;
            }
            const reader = new FileReader();
            reader.onload = function (event) {
                const text = event.target.result;
                processarCSV(text);
                log(`Dados carregados com sucesso!`);
            };
            reader.readAsText(input);
        }

        // Função para processar o CSV
        function processarCSV(text) {
            const linhas = text.trim().split("\n").slice(1); // Ignorar cabeçalho
            dados = [];

            linhas.forEach((linha) => {
                const valores = linha.split(",");
                const bolas = valores.slice(2, 17).map(Number);
                if (bolas.length === 15 && bolas.every(num => !isNaN(num))) {
                    dados.push({ bolas });
                }
            });
            if (dados.length === 0) {
                alert("Nenhum dado válido encontrado!");
            }
        }

        // Função para criar o modelo do Sherlock
        async function criarModelo() {
            if (!model) {
                model = tf.sequential();
                model.add(tf.layers.dense({ units: 128, activation: 'relu', inputShape: [15] }));
                model.add(tf.layers.dense({ units: 128, activation: 'relu' }));
                model.add(tf.layers.dense({ units: 15, activation: 'sigmoid' }));
                model.compile({ optimizer: 'adam', loss: 'meanSquaredError' });
            }
        }

        // Função para treinar o modelo do Sherlock
        async function treinarModelo() {
            if (dados.length === 0) {
                alert("Carregue os dados primeiro!");
                return;
            }
            if (treinando) {
                alert("O modelo já está sendo treinado.");
                return;
            }
            treinando = true;
            await criarModelo();

            const xs = tf.tensor2d(dados.map(d => d.bolas.map(bola => bola / 25)));
            const ys = tf.tensor2d(dados.map(d => d.bolas.map(bola => bola / 25)));

            const numEpocas = 100;
            await model.fit(xs, ys, {
                epochs: numEpocas,
                callbacks: {
                    onEpochEnd: (epoch, logs) => {
                        const progresso = Math.floor(((epoch + 1) / numEpocas) * 100);
                        document.getElementById('progressBar').style.width = progresso + '%';
                        document.getElementById('progressBar').innerText = progresso + '%';
                        document.getElementById('statusTreinamento').innerText = `Época ${epoch + 1}/${numEpocas}, perda: ${logs.loss.toFixed(4)}`;
                        log(`Época ${epoch + 1}/${numEpocas}, perda: ${logs.loss.toFixed(4)}`);
                    }
                }
            });

            treinando = false;
            log("Treinamento concluído!");
            alert("Treinamento concluído!");
        }

        // Função para salvar modelo
        async function salvarModelo() {
            if (!model) {
                alert("Não há modelo treinado para salvar!");
                return;
            }
            const saveResult = await model.save('downloads://modelo_sherlock');
            alert("Modelo salvo com sucesso!");
        }

        // Função para carregar o modelo salvo
        async function carregarModelo() {
            const jsonInput = document.getElementById('modelJson').files[0];
            const weightsInput = document.getElementById('modelWeights').files[0];
            if (!jsonInput || !weightsInput) {
                alert("Por favor, selecione o arquivo do modelo e os pesos.");
                return;
            }
            model = await tf.loadLayersModel(tf.io.browserFiles([jsonInput, weightsInput]));
            alert("Modelo carregado com sucesso!");
        }

        // Função para jogar com o modelo
        async function jogarComModelo() {
            if (!model) {
                alert("Carregue ou treine um modelo primeiro!");
                return;
            }

            const ultimoConcurso = dados[dados.length - 1].bolas.map(bola => bola / 25);
            const xs = tf.tensor2d([ultimoConcurso]);
            const predicoes = await model.predict(xs).array();
            const palpites = predicoes[0].map(p => Math.round(p * 25));
            
            log(`Palpites: ${palpites.join(', ')}`);
            alert(`Palpites do Sherlock: ${palpites.join(', ')}`);
        }

        // Função para gerar palpites
        function gerarPalpites() {
            palpites = [];
            for (let i = 0; i < numCiclos; i++) {
                let palpite = Array.from({ length: 15 }, () => Math.floor(Math.random() * 25) + 1);
                palpites.push(palpite);
            }
        }

        // Função para iniciar o ciclo de previsões
        async function iniciarCiclo() {
            if (cicloRodando) {
                alert("O ciclo já está rodando.");
                return;
            }

            cicloRodando = true;
            palpites = [];
            gerarPalpites();

            for (let i = 0; i < numCiclos; i++) {
                const concurso = dados[dados.length - 1].bolas;
                const palpite = palpites[i];
                const acertos = palpite.filter(b => concurso.includes(b)).length;

                if (acertos >= 12) {
                    campeoes.push({ ciclo: i + 1, acertos });
                }

                atualizarPlacar();
            }
            cicloRodando = false;

            alert("Ciclo de previsões concluído.");
        }

        // Função para atualizar o placar
        function atualizarPlacar() {
            const placarHTML = document.getElementById('geracoesRanking');
            let lista = "";
            campeoes.forEach((campeao, idx) => {
                lista += `<li>Geracao ${idx + 1}: ${campeao.acertos} acertos</li>`;
            });
            placarHTML.innerHTML = lista;
        }

        // Função para registrar logs
        function log(mensagem) {
            const logContainer = document.getElementById('log');
            logContainer.innerHTML += mensagem + "\n";
            logContainer.scrollTop = logContainer.scrollHeight;
        }

    </script>
</body>
</html>
