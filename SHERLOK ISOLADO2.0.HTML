<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sherlock AI - Loteria com Aprendizado por Refor√ßo</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-vis"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        #jogo-container { display: flex; justify-content: center; margin: 20px 0; }
        .banca { background-color: lightgray; padding: 10px; border: 2px solid black; text-align: center; }
        .jogadores { display: flex; justify-content: space-around; }
        .log { margin-left: 20px; }
        .log p { font-size: 14px; }
    </style>
</head>
<body>
    <h1>Sherlock AI - Loteria com Aprendizado por Refor√ßo</h1>

    <!-- Bot√µes de controle -->
    <button id="btnAbrirCSV">Abrir CSV</button>
    <button id="btnTreinarModelo">Treinar Modelo</button>
    <button id="btnSalvarModelo">Salvar Modelo</button>
    <button id="btnJogar">Jogar</button>

    <!-- Container do Jogo -->
    <div id="jogo-container">
        <div id="banca" class="banca">üè¶ Banca</div>
        <div id="jogadores" class="jogadores"></div>
        <div id="log" class="log"></div>
    </div>

    <!-- Container dos Gr√°ficos -->
    <div id="grafico-container">
        <div id="grafico"></div>
    </div>

    <script>
        let dados = [];
        let model;

        // Parte 3: Processar CSV
        document.getElementById('btnAbrirCSV').addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => processarCSV(event.target.result);
                reader.readAsText(file);
            };
            input.click();
        });

        function processarCSV(text) {
            const linhas = text.trim().split("\n").slice(1);
            dados = [];

            linhas.forEach((linha) => {
                const valores = linha.split(",");
                const concurso = Number(valores[0]);
                const dataSorteio = new Date(valores[1].split("/").reverse().join("-")).getTime();
                const bolas = valores.slice(2, 17).map(Number);

                if (bolas.length === 15 && bolas.every(num => !isNaN(num))) {
                    dados.push({ concurso, dataSorteio, bolas });
                }
            });

            if (dados.length === 0) {
                alert("Nenhum dado v√°lido encontrado!");
            } else {
                alert("CSV carregado com sucesso!");
            }
        }

        // Parte 5.5: Treinar modelo
        async function treinarModelo() {
            model = tf.sequential();
            model.add(tf.layers.dense({ units: 128, activation: 'relu', inputShape: [17] }));
            model.add(tf.layers.dense({ units: 64, activation: 'relu' }));
            model.add(tf.layers.dense({ units: 15, activation: 'softmax' }));
            model.compile({ optimizer: 'adam', loss: 'categoricalCrossentropy' });

            const { sequencias, labels } = prepararSeriesTemporais(dados, 10);
            const xs = tf.tensor2d(sequencias);
            const ys = tf.tensor2d(labels);

            await model.fit(xs, ys, {
                epochs: 50,
                callbacks: tfvis.show.fitCallbacks(
                    { name: 'Performance do Modelo' },
                    ['loss'],
                    { height: 200, callbacks: ['onEpochEnd'] }
                )
            });

            alert("Modelo treinado com sucesso!");
        }

        document.getElementById('btnTreinarModelo').addEventListener('click', treinarModelo);

        // Fun√ß√£o para preparar s√©ries temporais
        function prepararSeriesTemporais(dados, janela) {
            let sequencias = [];
            let labels = [];

            for (let i = 0; i < dados.length - janela; i++) {
                let sequencia = dados.slice(i, i + janela);
                let label = dados[i + janela].bolas;

                // Garantir que cada exemplo tenha 17 elementos
                sequencias.push(sequencia.flatMap(d => [...d.bolas])); // Somente bolas
                sequencias[i] = [...sequencias[i], sequencia[0].concurso, sequencia[0].dataSorteio]; // Adiciona concurso e data
                labels.push(label);
            }

            return { sequencias, labels };
        }

        // Parte 8: Jogo animado com √≠cones
        function iniciarJogo() {
            const jogadoresDiv = document.getElementById('jogadores');
            jogadoresDiv.innerHTML = '';

            for (let i = 0; i < 10; i++) {
                const jogadorDiv = document.createElement('div');
                jogadorDiv.className = 'jogador';
                jogadorDiv.innerHTML = `ü§ñ Sherlock ${i + 1}`;
                jogadoresDiv.appendChild(jogadorDiv);
            }

            atualizarLog("Jogo iniciado!");
        }

        function atualizarLog(mensagem) {
            const logDiv = document.getElementById('log');
            const logMsg = document.createElement('p');
            logMsg.textContent = mensagem;
            logDiv.appendChild(logMsg);
        }

        document.getElementById('btnJogar').addEventListener('click', iniciarJogo);
    </script>
</body>
</html>
